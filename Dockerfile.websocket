FROM node:18-alpine

WORKDIR /app

# Copy package files
COPY package*.json ./

# Install only production dependencies
RUN npm ci --only=production && npm cache clean --force

# Copy websocket server and prisma schema
COPY websocket-server.js ./
COPY prisma ./prisma/

# Generate Prisma client
RUN npx prisma generate

# Create non-root user
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 websocket

USER websocket

EXPOSE 3001

CMD ["node", "websocket-server.js"]